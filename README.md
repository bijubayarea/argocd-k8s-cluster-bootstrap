# argocd-k8s-cluster-bootstrap

## Deploy argoCD

Install Argo CD
All those components could be installed using a manifest provided by the Argo Project:
```
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.4.7/manifests/install.yaml

```

IF NEEDED Install Argo CD CLI
To interact with the API Server we need to deploy the CLI:
```
sudo curl --silent --location -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.4.7/argocd-linux-amd64

sudochmod +x /usr/local/bin/argocd

```



Expose argocd-server
By default argocd-server is not publicaly exposed.  we will use a Load Balancer to make it usable:
```
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
Wait about 2 minutes for the LoadBalancer creation

export ARGOCD_SERVER=`kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'`





```

Login
The initial password is autogenerated with the pod name of the ArgoCD API server:

```
export ARGO_PWD=`kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}"| base64 -d`

Using admin as login and the autogenerated password:
argocd login $ARGOCD_SERVER --username admin --password $ARGO_PWD --insecure

You should get as an output:
'admin'logged insuccessfully
```

## Deploy ArgoCD App-set (`boot-strap-app-set`) for Ingress-Controller: 

boot-strap-apps from github repo : `repoURL: https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git`

See app-set at `repoURL: https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git/application-set/boot-strap-app-set/boot-strap-app-set.yaml`

This will install ingress-controller and cert-manager

```
 - git:
      repoURL: https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git
      revision: HEAD
      directories:
      - path: application-sets/boot-strap-apps/*

```
Install the App-set either using following ARGO CLI or from  web interface from LB `(581f61c66fa5407d8e6d89c12c1e479-1081541614.us-west-2.elb.amazonaws.com)`
```
argocd app create boot-strap --project default --sync-policy none --sync-option CreateNamespace=true \
     --repo https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git \
     --path ./application-set/boot-strap-app-set/  \
     --dest-server https://kubernetes.default.svc --dest-namespace argocd 
```

## Deploy ArgoCD App-set (`httpecho-app-set`) for test http-echo: 

See app-set at `repoURL: https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git/application-set/boot-strap-app-set/boot-strap-app-set.yaml`

This will install 2 deployments echo1 and echo2. Please see `https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap/application-set/test-apps/http-echo`

```
 - git:
      repoURL: https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git
      revision: HEAD
      directories:
      - path: application-sets/test-apps/*

```
Install the App-set either using following ARGO CLI or from  web interface 
from LB `(581f61c66fa5407d8e6d89c12c1e479-1081541614.us-west-2.elb.amazonaws.com)`
App-set provisions : namespace, deployment, service and ingress

```
argocd app create test-apps --project default --sync-policy none --sync-option CreateNamespace=true \
     --repo https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap.git \
     --path ./application-set/test-app-set/  \
     --dest-server https://kubernetes.default.svc --dest-namespace argocd 
```



## Manage DNS record for http-echo:

Please use your own Cloud environment and Manage DNS record to point DomainName to `ingress-nginx` external load balancer
o test the Ingress, navigate to your DNS management service and create A records for echo1.example.com and echo2.example.com pointing to the DigitalOcean Load Balancer’s external IP. The Load Balancer’s external IP is the external IP address for the ingress-nginx Service, which we fetched in the previous step. If you are using DigitalOcean to manage your domain’s DNS records, consult  [How to Manage DNS Records](https://www.digitalocean.com/docs/networking/dns/how-to/manage-records/) to learn how to create A records.

To find `ingress-nginx` external load balancer. Create Record to point *.bijubayarea.tk to LB of ngress-nginx-controller
```
$ kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
afd597bb1a7d54c099cee24475938458-1587408250.us-west-2.elb.amazonaws.com
```

![](https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap/blob/main/images/Route53_config.png)

Once you’ve created the necessary echo1.example.com and echo2.example.com DNS records, you can test the Ingress Controller and Resource you’ve created using the curl command line utility or browser http://echo1.bijubayarea.tk  (TLS to be added below)



```
curl echo1.bijubayarea.tk

Output
echo1
```
![](https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap/blob/main/images/echo_1_image.png)

![](https://github.com/bijubayarea/argocd-k8s-cluster-bootstrap/blob/main/images/echo_2_image.png)


## Installing and Configuring Cert-Manager
 install v1.7.1 of cert-manager into our cluster. cert-manager is a Kubernetes add-on that provisions TLS certificates from Let’s Encrypt and other certificate authorities (CAs) and manages their lifecycles. Certificates can be automatically requested and configured by annotating Ingress Resources, appending a tls section to the Ingress spec, and configuring one or more Issuers or ClusterIssuers to specify your preferred certificate authority. To learn more about Issuer and ClusterIssuer objects, consult the official cert-manager documentation on [Issuers](https://cert-manager.io/docs/concepts/issuer/).

Install cert-manager and its [Custom Resource Definitions](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) (CRDs) like Issuers and ClusterIssuers by following the official [installation instructions](https://cert-manager.io/docs/installation/kubernetes/). Note that a namespace called cert-manager will be created into which the cert-manager objects will be created:

## To delete argoCD app:

```
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "ClusterIP"}}'
argocd app delete boot-strap
argocd app delete test-apps

```


```

```

```

```